<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>Krypto Ruletka — Mobile</title>
<style>
  :root{
    --bg1: #153e2b;
    --bg2: #0d2b1d;
    --card: #1f2937;
    --muted: #9ca3af;
    --accent: #eab308;
    --green: #16a34a;
    --red: #dc2626;
    --black: #000;
    --gap: 12px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
    color: #fff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding: 18px;
  }
  .container{
    max-width:480px;
    margin:0 auto;
  }
  .card{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    margin-bottom:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.35);
  }
  h1{font-size:20px;text-align:center;margin-bottom:6px}
  .center{text-align:center}
  .info{color:var(--muted);font-size:13px;text-align:center;margin-top:6px}
  .balance{font-size:20px;color:var(--accent);font-weight:700;text-align:center;margin:8px 0}
  button{display:inline-block;width:100%;padding:12px;border-radius:10px;border:none;font-weight:700;font-size:16px;cursor:pointer}
  button:disabled{opacity:0.5;cursor:not-allowed}
  .btn-primary{background:var(--accent);color:#000}
  .btn-green{background:var(--green);color:#fff}
  .btn-red{background:var(--red);color:#fff}
  .chips{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:10px}
  .chip{aspect-ratio:1/1;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;cursor:pointer;background:#3b82f6;border:3px solid transparent}
  .chip.selected{background:var(--accent);color:#000;border-color:#fde047}
  .chip.all-in{background:linear-gradient(135deg,#9333ea,#db2777)}
  .numbers{display:grid;grid-template-columns:repeat(12,1fr);gap:6px;margin-top:10px}
  .number{aspect-ratio:1/1;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;cursor:pointer;border:none}
  .number.red{background:var(--red);color:#fff}
  .number.black{background:var(--black);color:#fff}
  .number.green{background:var(--green);color:#fff}
  .outside{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  .bets-list{max-height:140px;overflow:auto;margin-top:8px}
  .bet-item{background:#374151;padding:8px;border-radius:8px;margin-bottom:6px;display:flex;justify-content:space-between;font-size:13px}
  .timer{font-size:28px;text-align:center;color:var(--accent);font-weight:700;padding:10px}
  .result-number{font-size:36px;text-align:center;padding:12px;border-radius:10px;font-weight:800;display:inline-block;margin:8px auto}
  .small{font-size:12px;color:var(--muted)}
  /* spinner */
  .spinner{width:48px;height:48px;border-radius:50%;border:5px solid var(--accent);border-top-color:transparent;margin:12px auto;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  /* mobile tap targets */
  @media (max-width:420px){
    .chip{font-size:12px}
    button{padding:14px;font-size:15px}
    .number{font-size:12px}
  }
</style>
</head>
<body>
<div class="container">
  <div id="app"></div>
</div>

<script>
/* ==========================
   Konfiguracja (zmień wg potrzeb)
   ========================== */
const ROULETTE = '0xAF8fB14c7A0410341D20E8183e2F449BF043a756';
const TOKEN    = '0x47E4A357073e9D3E87717244C0B97b6fb038efe1';
const CROUPIER = '0x5B87833D4414eBC85c5E1De5AEB8766AE11e013e';

/* ==========================
   Stan aplikacji
   ========================== */
let account = null;
let balance = 0;
let isCroupier = false;
let selectedChip = '100'; // trzymamy jako string, 'ALL' lub liczba w stringu
let bets = [];
let timer = null;
let gamePhase = 'betting'; // betting | spinning | result
let winningNum = '';
let isTimerRunning = false;
let loading = false;
let roundId = 0;
let offlineMode = false; // jeśli true -> symulacja bez MetaMask

const MAX_BET = 10000; // ograniczenie testowe, żeby uniknąć problemów z dużymi liczbami
const chips = [25,50,100,250,500,'ALL'];
const red = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
const layout = [
  [3,6,9,12,15,18,21,24,27,30,33,36],
  [2,5,8,11,14,17,20,23,26,29,32,35],
  [1,4,7,10,13,16,19,22,25,28,31,34]
];

/* ==========================
   Utility
   ========================== */
function safeHexToInt(hex){ try{ if(!hex) return 0; return parseInt(String(hex),16)||0 }catch(e){return 0} }
function formatBalance(b){ return Number(b).toLocaleString('pl-PL', {maximumFractionDigits:3}) }
function getColorClass(n){
  if (Number(n) === 0) return 'green';
  return red.includes(Number(n)) ? 'red' : 'black';
}

/* ==========================
   Połączenie / Simulacja
   ========================== */
async function connect(){
  if (offlineMode){ render(); return; }
  if (!window.ethereum){
    alert('Brak MetaMask / web3. Włącz tryb Offline (TEST) aby przetestować UI.');
    return;
  }
  try{
    loading = true; render();
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    account = accounts && accounts[0] ? accounts[0] : null;
    isCroupier = account && account.toLowerCase() === CROUPIER.toLowerCase();

    // pobierz balance tokena (ERC20 balanceOf) - zabezpieczone
    try{
      const balData = '0x70a08231' + account.substring(2).padStart(64,'0');
      const balResult = await window.ethereum.request({ method:'eth_call', params:[{to:TOKEN,data:balData},'latest'] });
      balance = safeHexToInt(balResult) / 1e18;
    }catch(e){
      console.error('Błąd pobrania salda:',e);
      balance = 0;
    }

    // pobierz roundId (jeśli kontrakt udostępnia funkcję bez parametrów)
    try{
      const roundData = '0x7c602d9c';
      const roundResult = await window.ethereum.request({ method:'eth_call', params:[{to:ROULETTE,data:roundData},'latest'] });
      roundId = safeHexToInt(roundResult);
    }catch(e){
      console.warn('Nie udało się pobrać roundId (symulacja ok).', e);
    }

  }catch(e){
    alert('Błąd połączenia: ' + (e.message||e));
    console.error(e);
  }finally{
    loading = false; render();
  }
}

/* ==========================
   Place bet (proste)
   ========================== */
async function placeBet(type,val){
  if (loading || gamePhase !== 'betting'){ return; }
  let amount = selectedChip === 'ALL' ? balance : Number(selectedChip);
  if (!amount || amount <= 0 || Number.isNaN(amount)){
    alert('Wybierz poprawny żeton.');
    return;
  }
  if (amount > balance){
    alert('Masz za mało środków.');
    return;
  }
  if (amount > MAX_BET){
    alert('Maksymalny zakład to ' + MAX_BET);
    return;
  }

  loading = true; render();
  try{
    if (offlineMode){
      // symulacja transakcji
      await new Promise(r=>setTimeout(r,500));
      bets.push({type,val,amount});
      balance = Math.max(0, balance - amount);
      alert('Zakład (symulacja) ustawiony');
      loading = false; render(); return;
    }

    // Approve (prosty przykład) + transakcja na kontrakt ruletki
    const amountWeiHex = Math.floor(amount * 1e18).toString(16).padStart(64,'0');
    const approveData = '0x095ea7b3' + ROULETTE.substring(2).padStart(64,'0') + 'f'.repeat(64);
    await window.ethereum.request({ method:'eth_sendTransaction', params:[{from:account,to:TOKEN,data:approveData}] });

    // krótkie oczekiwanie (najlepiej śledzić receipt, to demo)
    await new Promise(r=>setTimeout(r,1200));

    // budujemy calldata placeBet - DEMO (trzeba dopasować do ABI)
    let betData = '0x27002ca8';
    betData += type.toString(16).padStart(64,'0');
    betData += '0000000000000000000000000000000000000000000000000000000000000060';
    betData += amountWeiHex;
    if (typeof val === 'number'){
      betData += '0000000000000000000000000000000000000000000000000000000000000001';
      betData += val.toString(16).padStart(64,'0');
    } else {
      betData += '0000000000000000000000000000000000000000000000000000000000000000';
    }

    await window.ethereum.request({ method:'eth_sendTransaction', params:[{from:account,to:ROULETTE,data:betData}] });

    bets.push({type,val,amount});
    balance = Math.max(0, balance - amount);
    alert('Zakład wysłany (tx wysłane).');

  }catch(e){
    console.error('placeBet error', e);
    alert('Błąd: ' + (e.message||e));
  }finally{
    loading = false; render();
  }
}

/* ==========================
   Start runda / finalize
   ========================== */
async function startRound(){
  if (loading) return;
  loading = true; render();
  try{
    if (offlineMode){ roundId++; bets=[]; gamePhase='betting'; alert('Nowa runda (symulacja)'); loading=false; render(); return; }
    const data = '0x2f30caee';
    await window.ethereum.request({ method:'eth_sendTransaction', params:[{from:account,to:ROULETTE,data}] });
    roundId++; bets=[]; gamePhase='betting';
    alert('Runda rozpoczęta (tx wysłane).');
  }catch(e){ console.error(e); alert('Błąd: ' + (e.message||e)); }
  loading=false; render();
}

function startTimer(){
  if (isTimerRunning || loading || gamePhase !== 'betting') return;
  timer = 10; isTimerRunning = true; render();
  const interval = setInterval(()=>{
    timer--;
    if (timer <= 0){
      clearInterval(interval);
      isTimerRunning = false; timer = null; gamePhase = 'spinning';
      render();
    } else {
      render();
    }
  },1000);
}

async function finalize(){
  if (loading) return;
  const num = parseInt(winningNum);
  if (Number.isNaN(num) || num < 0 || num > 36){
    alert('Wpisz poprawny numer 0-36.');
    return;
  }
  loading = true; render();
  try{
    if (offlineMode){ gamePhase='result'; alert('Wynik (symulacja) ustawiony.'); loading=false; render(); return; }
    const data = '0x0c08bf88' + num.toString(16).padStart(64,'0');
    await window.ethereum.request({ method:'eth_sendTransaction', params:[{from:account,to:ROULETTE,data}] });
    gamePhase = 'result';
  }catch(e){ console.error(e); alert('Błąd: ' + (e.message||e)); }
  loading=false; render();
}

/* ==========================
   Render UI (jedno miejsce)
   ========================== */
function render(){
  const app = document.getElementById('app');
  if (!app) return;
  // jeśli account nie ustawione i offlineMode false -> pokaż ekran połączenia
  if (!account && !offlineMode){
    app.innerHTML = `
      <div class="card center">
        <h1>🎰 Krypto Ruletka</h1>
        <p class="info">Połącz portfel (MetaMask / Wallet)</p>
        <div style="gap:8px;margin-top:12px">
          <button class="btn-primary" onclick="connect()" ${loading ? 'disabled' : ''}>${loading ? '⏳ Łączenie...' : '🔗 Połącz portfel'}</button>
          <button class="btn-green" onclick="offlineMode=true;account=null;render();" ${loading ? 'disabled' : ''} style="margin-top:8px">🧪 Tryb offline (test)</button>
        </div>
        <p class="small" style="margin-top:8px">Tryb offline symuluje salda i transakcje — przydatny do testów na telefonie.</p>
      </div>
    `;
    return;
  }

  // Gdy konto jest ustawione (albo offlineMode) - pokaż główne UI
  const showBalance = offlineMode ? balance : balance;
  const acctString = account ? account : 'TEST (offline)';
  const timerHtml = timer !== null ? `<div class="timer">⏰ ${timer}s</div>` : '';

  if (isCroupier && !offlineMode ? account && account.toLowerCase() === CROUPIER.toLowerCase() : false){
    // Jeśli jesteś krupierem (live)
    app.innerHTML = `
      <div class="card center">
        <h1>🎩 Krupier</h1>
        <div class="info">${acctString}</div>
        <div class="balance">${formatBalance(showBalance)} BLK</div>
        <div class="info">Runda #${roundId}</div>
      </div>
      <div class="card">
        ${gamePhase === 'betting' ? `<button class="btn-green" onclick="startTimer()" ${isTimerRunning || loading ? 'disabled' : ''}>⏱️ START (10s)</button>` : ''}
        ${gamePhase === 'spinning' ? `
          <div style="margin-top:10px">
            <input type="number" min="0" max="36" value="${winningNum}" placeholder="0-36" oninput="winningNum=this.value" style="width:100%;padding:12px;border-radius:8px;border:2px solid var(--accent);background:#374151;color:#fff;font-size:18px"/>
            <button class="btn-primary" style="margin-top:8px" onclick="finalize()" ${loading ? 'disabled' : ''}>✅ ROZLICZ</button>
          </div>` : ''}
        ${gamePhase === 'result' ? `
          <div class="center" style="margin-top:10px">
            <div class="result-number ${getColorClass(parseInt(winningNum))}">${winningNum}</div>
            <button class="btn-green" style="margin-top:8px" onclick="startRound()" ${loading ? 'disabled' : ''}>🔄 NOWA RUNDA</button>
          </div>` : ''}
      </div>
    `;
    return;
  }

  // Widok gracza
  app.innerHTML = `
    <div class="card center">
      <h1>🎰 Krypto Ruletka</h1>
      <div class="info">${acctString}</div>
      <div class="balance">💰 ${formatBalance(showBalance)} BLK</div>
      <div class="info">Runda #${roundId}</div>
      ${timerHtml}
    </div>

    ${gamePhase === 'betting' ? `
      <div class="card">
        <div class="small">Wybierz żeton</div>
        <div class="chips">
          ${chips.map(c => `
            <div class="chip ${String(c)===String(selectedChip)?'selected':''} ${c==='ALL'?'all-in':''}"
                 onclick="selectedChip='${c}';render();">
              ${c}
            </div>`).join('')}
        </div>
      </div>

      <div class="card">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button class="btn-primary" style="flex:1;padding:10px" onclick="placeBet(0,0)" ${loading ? 'disabled' : ''}>0</button>
        </div>

        <div class="numbers">
          ${layout.map(row => row.map(n => `
            <button class="number ${getColorClass(n)}" onclick="placeBet(0,${n})" ${loading ? 'disabled' : ''}>${n}</button>
          `).join('')).join('')}
        </div>

        <div class="outside" style="margin-top:10px">
          <button onclick="placeBet(9,null)" ${loading ? 'disabled' : ''}>1-12</button>
          <button onclick="placeBet(10,null)" ${loading ? 'disabled' : ''}>13-24</button>
          <button onclick="placeBet(11,null)" ${loading ? 'disabled' : ''}>25-36</button>
          <button onclick="placeBet(7,null)" ${loading ? 'disabled' : ''}>1-18</button>
          <button onclick="placeBet(8,null)" ${loading ? 'disabled' : ''}>19-36</button>
          <button onclick="placeBet(3,null)" ${loading ? 'disabled' : ''} style="background:var(--red);color:#fff">RED</button>
          <button onclick="placeBet(4,null)" ${loading ? 'disabled' : ''} style="background:var(--black);color:#fff">BLACK</button>
          <button onclick="placeBet(5,null)" ${loading ? 'disabled' : ''}>EVEN</button>
          <button onclick="placeBet(6,null)" ${loading ? 'disabled' : ''}>ODD</button>
        </div>
      </div>
    ` : '' }

    ${bets.length > 0 ? `
      <div class="card">
        <div class="small">Twoje zakłady</div>
        <div class="bets-list">
          ${bets.map(b => `<div class="bet-item"><span>Typ:${b.type} Val:${b.val===null?'-':b.val}</span><span style="color:var(--accent)">${formatBalance(b.amount)}</span></div>`).join('')}
        </div>
        <div style="text-align:right;font-weight:700;margin-top:6px">Suma: ${formatBalance(bets.reduce((s,x)=>s+x.amount,0))}</div>
        <button class="btn-red" style="margin-top:8px" onclick="bets=[];render()" ${loading ? 'disabled' : ''}>❌ ANULUJ</button>
      </div>` : ''}

    ${gamePhase === 'spinning' ? `
      <div class="card center">
        <h2>🎲 Krupier obraca ruletką...</h2>
        <div class="spinner"></div>
      </div>` : ''}

    ${gamePhase === 'result' ? `
      <div class="card center">
        <h2>Wynik</h2>
        <div class="result-number ${getColorClass(parseInt(winningNum))}">${winningNum}</div>
      </div>` : ''}

    ${loading ? `<div style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;"><div class="card center" style="max-width:200px"><div class="spinner"></div><div style="margin-top:6px">Przetwarzanie...</div></div></div>` : ''}
  `;
}

/* start */
render();

/* expose some helpers in global for inline onclicks */
window.connect = connect;
window.placeBet = placeBet;
window.startRound = startRound;
window.startTimer = startTimer;
window.finalize = finalize;
window.render = render;

</script>
</body>
</html>
